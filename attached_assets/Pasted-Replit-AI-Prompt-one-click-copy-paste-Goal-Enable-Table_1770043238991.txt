Replit AI Prompt (one-click copy/paste)

Goal: Enable Tables season dropdown (e.g. 2024/25, 2023/24) to load standings for ALL leagues/cups by backfilling historical seasons from Goalserve. Also ensure /api/jobs/upsert-goalserve-standings returns JSON (not the SPA HTML fallback). DO NOT run automated regression tests, Playwright/Cypress, or generate videos/screenshots. I will manually test post-deploy.

Context:
- UI dropdown seasons are: "2025/26", "2024/25", "2023/24", "2022/23".
- Goalserve historical standings require a `season` query param using dash format + full end year, e.g. season=2018-2019 (see Soccer Data Feed PDF, “Historical results and standings feed”).
- Current code builds Goalserve standings URL like:
  `https://www.goalserve.com/getfeed/${GOALSERVE_FEED_KEY}/standings/${leagueId}.xml?json=true`
  which always fetches current season and ignores requested season.

Tasks:

1) Add a season normaliser utility (server-side) that converts:
   - "2024/25" -> "2024-2025"
   - "2024/2025" -> "2024-2025"
   - "2024-25" -> "2024-2025"
   - "2024-2025" stays "2024-2025"
   - If season is missing/empty, leave undefined (meaning current season).
   Put this in a reusable place, e.g. `server/lib/season.ts` or similar.

   Rules:
   - Parse the first year as 4 digits.
   - Parse the second part (2 or 4 digits). If 2 digits, expand to the correct century based on the first year (e.g. 2024 + "25" => 2025).
   - Output ALWAYS "YYYY-YYYY".

2) Update `server/jobs/upsert-goalserve-standings.ts`:
   - When building the Goalserve URL, include the season query param if provided:
     `.../standings/${leagueId}.xml?json=true&season=${normalizedSeason}`
     (or `?season=...&json=true` — either order is fine)
   - Ensure the ingested snapshot stores `season` as the normalized season string (e.g. "2024-2025").
   - Keep current behaviour if no seasonParam is provided: fetch current season and store whatever tournament["@season"] resolves to, but NORMALISE it before writing to DB for consistency.

3) Update `server/routes.ts` for:
   a) `/api/standings`
      - Accept `season` in any of the UI formats.
      - Normalize it immediately and use normalizedSeason for:
        - snapshot lookup: `eq(standingsSnapshots.season, normalizedSeason)`
        - auto-refresh ingest call: `upsertGoalserveStandings(leagueId, { seasonParam: normalizedSeason, ... })`
      - If client passes "2024/25", it should transparently work.

   b) `/api/jobs/upsert-goalserve-standings`
      - Normalize the incoming `season` query param before passing to the job.
      - Return JSON always (no SPA HTML). If this route is currently being shadowed by a catch-all, ensure API routes are registered BEFORE any `app.get("*", ...)` or Vite/static fallback handler.

4) Client: `client/src/pages/tables.tsx`
   - Ensure when the user selects a season like "2024/25", the API call includes `season=2024/25` (fine) OR you may choose to send the normalized form. Either is acceptable as long as server normalises.
   - Behaviour requirement: changing season should update tables across leagues/cups (the existing UI already uses the season state; just ensure the fetch includes season and refreshes data).

5) Add minimal, cheap debug logging (no noisy dumps):
   - When `/api/standings` is called, log once:
     `[Standings] leagueId=1204 seasonRaw=2024/25 seasonNorm=2024-2025`
   - When upserting standings, log the final Goalserve URL (truncate key):
     `[StandingsIngest] url=/standings/1204.xml?json=true&season=2024-2025`

6) Manual verification steps (DO NOT run tests):
   - Start dev server.
   - Hit:
     - `curl -i "http://localhost:5000/api/jobs/upsert-goalserve-standings?leagueId=1204&season=2024/25&force=true"`
       Expect JSON response with ok/skipped/insertedRowsCount etc (not HTML).
     - `curl -i "http://localhost:5000/api/standings?leagueId=1204&season=2024/25"`
       Expect 200 with rows (not "No standings snapshot found").
   - In UI: Tables -> select 2024/25 -> Premier League shows standings (no error banner).

Constraints:
- Do NOT change unrelated UI.
- Do NOT add tooltip complexity.
- Do NOT run or generate regression tests/videos.
- Keep changes minimal and focused.

Deliverables:
- Code changes committed in the appropriate files.
- A short summary of what you changed and the exact curl commands to verify.
